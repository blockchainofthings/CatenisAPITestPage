<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Test Catenis API</title>

        <script src="lib/CatenisAPIClientJS.min.js"></script>
        <script language="JavaScript">
            var ctnApiClient;
            var device = {};
            var lastTxid;

            function resetDevice() {
                device = {};
            }

            function initApiClient() {
                var env = document.getElementById('selEnvironment').value === 'localhost' ? {
                            defaultDevice: {
                                deviceId: 'dK9xt9QnNWM4TBTfZPRQ',
                                apiAccessSecret: 'fb1f2be9889ed42a4ddf08f13fe77c13aeb237594d0449e047d5f9ae6a8d83447042a2f6cb7a413c1feecfdc4d9b6cc591aaa95d690d5a563089f7c76ea2932b'
                            },
                            opts: {
                                host: 'localhost:3000',
                                secure: false
                            }
                        } : {
                            defaultDevice: {
                                deviceId: 'dmM2Dz32agLSGsSuoxsR',
                                apiAccessSecret: '99e3eb869b089e1f0e4ec4847aac01c6a82949eff19dbd10da9650eda525307ffc44715ae773d8cc8ca3f5515167b5ffd7cc16ffc567cb2c8a6e91013d0d1f38'
                            },
                            opts: {
                                environment: 'beta'
                            }
                        };

                if (!device.deviceId) {
                    device = env.defaultDevice;
                    resetDeviceIdField();
                }

                ctnApiClient = new CtnApiClient(device.deviceId, device.apiAccessSecret, env.opts);
            }

            function logMessage(message, encoding, encrypt, storage) {
                ctnApiClient.logMessage(message, {
                    encoding: encoding,
                    encrypt: encrypt,
                    storage: storage
                }, processMessageResult);
            }

            function sendMessage(targetDeviceId, isProdUniqueId, message, encoding, encrypt, storage) {
                ctnApiClient.sendMessage({
                    id: targetDeviceId,
                    isProdUniqueId: isProdUniqueId
                }, message, {
                    encoding: encoding,
                    encrypt: encrypt,
                    storage: storage
                }, processMessageResult);
            }

            function readMessage(txid, encoding) {
                ctnApiClient.readMessage(txid, encoding, processResult);
            }

            function processMessageResult(err, data) {
                if (!err && typeof data.data === 'object' && data.data !== null && typeof data.data.txid === 'string') {
                    lastTxid = data.data.txid;
                }

                processResult(err, data);
            }

            function processResult(err, data) {
                //showArgs.bind(undefined, 'processResult')(arguments);
                if (err) {
                    showResult(err, true);
                }
                else {
                    showResult(data);
                }
            }

            function showResult(data, isError) {
                //document.getElementById('pReqResult').innerHTML = (isError ? '<span style="color: red;">ERROR:</span>' : '') + '<pre>' + JSON.stringify(data, null, '  ') + '</pre>';
                document.getElementById('pReqResult').innerHTML = (isError ? '<span style="color: red;">ERROR:</span>' : '') + '<pre>' + JSON.stringify(data, null, '  ') + '</pre>';
            }

            function clearResult() {
                document.getElementById('pReqResult').innerHTML = '';
            }

            function requireMessage() {
                var msg = document.getElementById('itxMessage').value;

                if (msg && msg.length > 0) {
                    return true;
                }
                else {
                    alert('Please enter a message');
                    return false;
                }
            }

            function requireTargetDevice() {
                var trgtDev = document.getElementById('itxTrgtDeviceId').value;

                if (trgtDev && trgtDev.length > 0) {
                    return true;
                }
                else {
                    alert('Please enter a target device ID');
                    return false;
                }
            }

            function requireTxid() {
                var txid = document.getElementById('itxTxid').value;

                if (txid && txid.length > 0) {
                    return true;
                }
                else {
                    alert('Please enter a transaction ID');
                    return false;
                }
            }

            function updateDeviceId(ctrl) {
                if (ctrl.value && ctrl.value.length > 0) {
                    var oldDeviceId = device.deviceId;

                    if (oldDeviceId != ctrl.value) {
                        var newApiAccessSecret;

                        do {
                            newApiAccessSecret = prompt('Please enter API access secret for device');
                        }
                        while (newApiAccessSecret !== null && newApiAccessSecret.length == 0);

                        if (newApiAccessSecret !== null) {
                            device.deviceId = ctrl.value;
                            device.apiAccessSecret = newApiAccessSecret;

                            clearResult();
                            initApiClient();
                        }
                        else {
                            resetDeviceIdField();
                        }
                    }
                }
                else {
                    resetDeviceIdField();
                }
            }

            function resetDeviceIdField() {
                document.getElementById('itxDeviceId').value = device.deviceId;
            }

            function fillWithLastTxid() {
                if (lastTxid) {
                    document.getElementById('itxTxid').value = lastTxid;
                }
            }

            function showArgs(label) {
                var argList = 'Source: ' + label;
                argList += '\nthis: ' + this;
                var args = Array.prototype.slice.call(arguments);
                args.shift();
                args.forEach(function (arg, idx) {
                    if (argList.length > 0) {
                        argList += '\n';
                    }
                    argList += 'Arg.#' + (idx + 1) + ': ' + JSON.stringify(arg);
                });
                alert(argList);
            }
        </script>
    </head>
    <body>
        <div id="divEnvironment">
            <label for="selEnvironment">Environment: </label><select id="selEnvironment" onchange="clearResult(); resetDevice(); initApiClient()">
                <option value="localhost" selected>localhost</option>
                <option value="Catenis-API">Catenis API server</option>
            </select>
            <br/><label for="itxDeviceId">Device ID: </label><input id="itxDeviceId" maxlength="20" size="30" onchange="updateDeviceId(this)"/>
            <script language="JavaScript">resetDeviceIdField()</script>
        </div>
        <div id="divMessage" style="margin-top:1em">
            <table>
                <tr>
                    <td valign="top" align="right">
                        <label for="itxMessage">Message: </label>
                    </td>
                    <td>
                        <textarea id="itxMessage" rows="5" cols="80"></textarea>
                        <br/><label for="selMsgEncoding">encoding: </label><select id="selMsgEncoding">
                            <option value="utf8" selected>UTF-8</option>
                            <option value="base64">Base-64</option>
                            <option value="hex">Hex</option>
                        </select>
                        <br/><label for="cbxMsgEncrypt">encrypt: </label><input id="cbxMsgEncrypt" type="checkbox" checked />
                        <br/><label for="selMsgStorage">storage: </label><select id="selMsgStorage">
                            <option value="auto" selected>Auto</option>
                            <option value="embedded">Embedded</option>
                            <option value="external">External</option>
                        </select>
                        <br/><button id="btnLogMessage" style="margin-top:10px" onclick="clearResult(); if(requireMessage()){logMessage(document.getElementById('itxMessage').value, document.getElementById('selMsgEncoding').value, document.getElementById('cbxMsgEncrypt').checked, document.getElementById('selMsgStorage').value)}else{return false}">Log Message</button>
                        <div style="margin-top:1em">
                            <table>
                                <tr>
                                    <td valign="top">
                                        <label for="itxTrgtDeviceId">Target device ID: </label>
                                    </td>
                                    <td>
                                        <input id="itxTrgtDeviceId" style="margin-bottom:0.5em" type="text" maxlength="40" size="40"/>
                                        <br/><label for="cbxProdUniqId">product unique ID: </label><input id="cbxProdUniqId" type="checkbox"/>
                                        <br/><button id="btnSendMessage" style="margin-top:10px" onclick="clearResult(); if(requireMessage() && requireTargetDevice()){sendMessage(document.getElementById('itxTrgtDeviceId').value, document.getElementById('cbxProdUniqId').checked, document.getElementById('itxMessage').value, document.getElementById('selMsgEncoding').value, document.getElementById('cbxMsgEncrypt').checked, document.getElementById('selMsgStorage').value)}else{return false}">Send Message</button>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td valign="top" align="right" style="padding-top:1.25em">
                        <label for="itxTxid">Transaction ID: </label>
                    </td>
                    <td style="padding-top:1em">
                        <input id="itxTxid" style="margin-bottom:0.5em" type="text" maxlength="64" size="80"/>
                        <div width="100%" align="right" style="margin-right:30px;margin-bottom:-1em"><a href="javascript:fillWithLastTxid()">Fill with last txid</a></div>
                        <label for="selRdMsgEncoding">encoding: </label><select id="selRdMsgEncoding">
                            <option value="utf8" selected>UTF-8</option>
                            <option value="base64">Base-64</option>
                            <option value="hex">Hex</option>
                        </select>
                        <br/><button id="btnReadMessage" style="margin-top:10px" onclick="clearResult(); if(requireTxid()){readMessage(document.getElementById('itxTxid').value, document.getElementById('selRdMsgEncoding').value)}else{return false}">Read Message</button>
                    </td>
                </tr>
            </table>
        </div>
        <div id="divResult" style="margin-top:1em">
            <label>Result:</label><br/>
            <p id="pReqResult"></p>
        </div>
        <script language="JavaScript">clearResult(); initApiClient()</script>
    </body>
</html>