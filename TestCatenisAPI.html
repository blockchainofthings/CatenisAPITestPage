<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Test Catenis API</title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.6/sjcl.min.js"></script>

        <script language="JavaScript">
            var CtnApiClient;

            (function () {
                var apiPath = '/api/0.1',
                    signVersionId = 'CTN1',
                    signMethodId = 'CTN1-HMAC-SHA256',
                    scopeRequest = 'ctn1_request',
                    timestampHdr = 'X-BCoT-Timestamp',
                    signValidDays = 7;

                function ApiClient(host, secure, deviceId, apiAccessSecret) {
                    this.host = host;
                    this.uriPrefix = (secure ? 'https://' : 'http://') + this.host;
                    this.rootApiEndPoint = this.uriPrefix + apiPath;
                    this.deviceId = deviceId;
                    this.apiAccessSecret = apiAccessSecret;
                    this.lastSignDate = undefined;
                    this.lastSignKey = undefined;

                    this.reqParams = {};
                }

                ApiClient.processReturn = function (callback, data, returnType) {
                    if (returnType === 'error') {
                        callback(data);
                    }
                    else if (returnType === 'success') {
                        if (typeof data === 'object' && data !== null) {
                            var objKeys = Object.keys(data);
                            if (objKeys.length > 0 && objKeys[0] === 'error') {
                                callback(data);
                            }
                            else {
                                callback(undefined, data);
                            }
                        }
                    }
                };

                // Log a message
                //
                //  Parameters:
                //    message: [String]       // The message to store
                //    options: {
                //      encoding: [String],   // (optional, default: "utf8") - One of the following values identifying the encoding of the message: "utf8"|"base64"|"hex"
                //      encrypt:  [Boolean],  // (optional, default: true) - Indicates whether message should be encrypted before storing
                //      storage: [String]     // (optional, default: "auto") - One of the following values identifying where the message should be stored: "auto"|"embedded"|"external"
                //  }
                ApiClient.prototype.logMessage = function (message, options, callback) {
                    var data = {
                        message: message
                    };

                    if (options) {
                        data.options = options;
                    }

                    var successFunc = ApiClient.processReturn.bind(undefined, callback),
                        errorFunc = successFunc;

                    postRequest.call(this, 'message/log', data, {
                        success: successFunc,
                        error: errorFunc
                    })
                };

                // Send a message
                //
                //  Parameters:
                //    targetDevice: {
                //      id: [String],               // ID of target device. Should be Catenis device ID unless isProdUniqueId is true
                //      isProdUniqueId: [Boolean]   // (optional, default: false) Indicate whether supply ID is a product unique ID (otherwise, if should be a Catenis device Id)
                //    },
                //    message: [String],            // The message to send
                //    options: {
                //      encoding: [String],         // (optional, default: "utf8") - One of the following values identifying the encoding of the message: "utf8"|"base64"|"hex"
                //      encrypt:  [Boolean],        // (optional, default: true) - Indicates whether message should be encrypted before storing
                //      storage: [String]           // (optional, default: "auto") - One of the following values identifying where the message should be stored: "auto"|"embedded"|"external"
                //  }
                ApiClient.prototype.sendMessage = function (targetDevice, message, options, callback) {
                    var data = {
                        message: message,
                        targetDevice: targetDevice
                    };

                    if (options) {
                        data.options = options;
                    }

                    var successFunc = ApiClient.processReturn.bind(undefined, callback),
                        errorFunc = successFunc;

                    postRequest.call(this, 'message/send', data, {
                        success: successFunc,
                        error: errorFunc
                    });
                };

                ApiClient.prototype.readMessage = function (txid, encoding, callback) {
                    var params = {
                        url: [
                            txid
                        ]
                    };

                    if (encoding) {
                        params.query = {
                            encoding: encoding
                        };
                    }

                    var successFunc = ApiClient.processReturn.bind(undefined, callback),
                        errorFunc = successFunc;

                    getRequest.call(this, 'message/read', params, {
                        success: successFunc,
                        error: errorFunc
                    });
                };

                function postRequest(methodPath, data, result) {
                    var url = this.rootApiEndPoint + '/' + methodPath;

                    this.reqParams = {
                        url: url,
                        contentType: "application/json",
                        processData: false,
                        data: JSON.stringify(data),
                        type: "POST",
                        success: result.success,
                        error: result.error
                    };

                    signRequest.call(this);

                    $.ajax(this.reqParams);
                }

                function getRequest(methodPath, params, result) {
                    var url = this.rootApiEndPoint + '/' + methodPath;

                    if (typeof params === 'object' && params !== null) {
                        if (typeof params.url === 'object' && Array.isArray(params.url)) {
                            params.url.forEach(function (urlParam) {
                                url += '/' + encodeURI(urlParam);
                            });
                        }

                        if (typeof params.query === 'object' && params.query !== null) {
                            var queryStr = '';
                            for (var queryParam in params.query) {
                                queryStr += encodeURI(queryParam) + '=' + encodeURI(params.query[queryParam]);
                            }
                            if (queryStr.length > 0) {
                                url += '?' + queryStr;
                            }
                        }
                    }

                    this.reqParams = {
                        url: url,
                        type: "GET",
                        success: result.success,
                        error: result.error
                    };

                    signRequest.call(this);

                    $.ajax(this.reqParams);
                }

                function signRequest() {
                    // Add timestamp header
                    var now = moment();
                    var timestamp = moment.utc(now).format('YYYYMMDDTHHmmss[Z]');
                    var signDate,
                        useSameSignKey;

                    if (this.lastSignDate && now.diff(this.lastSignDate) < signValidDays) {
                        signDate = this.lastSignDate;
                        useSameSignKey = !!this.lastSignKey;
                    }
                    else {
                        signDate = this.lastSignDate = now.format('YYYYMMDD');
                        useSameSignKey = false;
                    }

                    this.reqParams.headers = this.reqParams.headers || {};
                    this.reqParams.headers[timestampHdr] = timestamp;

                    // First step: compute conformed request
                    var confReq = this.reqParams.type + '\n';
                    confReq += this.reqParams.url.substr(this.uriPrefix.length) + '\n';

                    var essentialHeaders = 'host:' + this.host + '\n';
                    essentialHeaders += timestampHdr.toLowerCase() + ':' + this.reqParams.headers[timestampHdr] + '\n';

                    confReq += essentialHeaders + '\n';
                    confReq += hashData(this.reqParams.data || '') + '\n';

                    // Second step: assemble string to find
                    var strToSign = signMethodId + '\n';
                    strToSign += timestamp + '\n';

                    var scope = signDate + '/' + scopeRequest;

                    strToSign += scope + '\n';
                    strToSign += hashData(confReq) + '\n';

                    // Third step: generate the signature
                    var signKey;

                    if (useSameSignKey) {
                        signKey = this.lastSignKey;
                    }
                    else {
                        var dateKey = signData(signDate, signVersionId + this.apiAccessSecret);
                        signKey = this.lastSignKey = signData(scopeRequest, dateKey);
                    }

                    var signature = signData(strToSign, signKey, true);

                    // Step four: add authorization header
                    this.reqParams.headers.Authorization = signMethodId + ' Credential=' + this.deviceId + '/' + scope + ', Signature=' + signature;
                }

                function hashData(data) {
                    return sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(data));
                }

                function signData(data, secret, hexEncode) {
                    var key = typeof secret === 'string' ? sjcl.codec.utf8String.toBits(secret) : secret;
                    var result = (new sjcl.misc.hmac(key)).encrypt(data);

                    return hexEncode ? sjcl.codec.hex.fromBits(result) : result;
                }

                // Export function class
                CtnApiClient = ApiClient;
            })();
        </script>
        <script language="JavaScript">
            var ctnApiClient;
            var device = {};
            var lastTxid;

            function resetDevice() {
                device = {};
            }

            function initApiClient() {
                var env = document.getElementById('selEnvironment').value === 'localhost' ? {
                            host: 'localhost:3000',
                            secure: false,
                            defaultDevice: {
                                deviceId: 'dK9xt9QnNWM4TBTfZPRQ',
                                apiAccessSecret: 'fb1f2be9889ed42a4ddf08f13fe77c13aeb237594d0449e047d5f9ae6a8d83447042a2f6cb7a413c1feecfdc4d9b6cc591aaa95d690d5a563089f7c76ea2932b'
                            }
                        } : {
                            host: 'beta.catenis.io',
                            secure: true,
                            defaultDevice: {
                                deviceId: 'dmM2Dz32agLSGsSuoxsR',
                                apiAccessSecret: '99e3eb869b089e1f0e4ec4847aac01c6a82949eff19dbd10da9650eda525307ffc44715ae773d8cc8ca3f5515167b5ffd7cc16ffc567cb2c8a6e91013d0d1f38'
                            }
                        };

                if (!device.deviceId) {
                    device = env.defaultDevice;
                    resetDeviceIdField();
                }

                ctnApiClient = new CtnApiClient(env.host, env.secure, device.deviceId, device.apiAccessSecret);
            }

            function logMessage(message, encoding, encrypt, storage) {
                ctnApiClient.logMessage(message, {
                    encoding: encoding,
                    encrypt: encrypt,
                    storage: storage
                }, processMessageResult);
            }

            function sendMessage(targetDeviceId, isProdUniqueId, message, encoding, encrypt, storage) {
                ctnApiClient.sendMessage({
                    id: targetDeviceId,
                    isProdUniqueId: isProdUniqueId
                }, message, {
                    encoding: encoding,
                    encrypt: encrypt,
                    storage: storage
                }, processMessageResult);
            }

            function readMessage(txid, encoding) {
                ctnApiClient.readMessage(txid, encoding, processResult);
            }

            function processMessageResult(err, data) {
                if (!err && typeof data.data === 'object' && data.data !== null && typeof data.data.txid === 'string') {
                    lastTxid = data.data.txid;
                }

                processResult(err, data);
            }

            function processResult(err, data) {
                //showArgs.bind(undefined, 'processResult')(arguments);
                if (err) {
                    showResult(err, true);
                }
                else {
                    showResult(data);
                }
            }

            function showResult(data, isError) {
                //document.getElementById('pReqResult').innerHTML = (isError ? '<span style="color: red;">ERROR:</span>' : '') + '<pre>' + JSON.stringify(data, null, '  ') + '</pre>';
                document.getElementById('pReqResult').innerHTML = (isError ? '<span style="color: red;">ERROR:</span>' : '') + '<pre>' + JSON.stringify(data, null, '  ') + '</pre>';
            }

            function clearResult() {
                document.getElementById('pReqResult').innerHTML = '';
            }

            function requireMessage() {
                var msg = document.getElementById('itxMessage').value;

                if (msg && msg.length > 0) {
                    return true;
                }
                else {
                    alert('Please enter a message');
                    return false;
                }
            }

            function requireTargetDevice() {
                var trgtDev = document.getElementById('itxTrgtDeviceId').value;

                if (trgtDev && trgtDev.length > 0) {
                    return true;
                }
                else {
                    alert('Please enter a target device ID');
                    return false;
                }
            }

            function requireTxid() {
                var txid = document.getElementById('itxTxid').value;

                if (txid && txid.length > 0) {
                    return true;
                }
                else {
                    alert('Please enter a transaction ID');
                    return false;
                }
            }

            function updateDeviceId(ctrl) {
                if (ctrl.value && ctrl.value.length > 0) {
                    var oldDeviceId = device.deviceId;

                    if (oldDeviceId != ctrl.value) {
                        var newApiAccessSecret;

                        do {
                            newApiAccessSecret = prompt('Please enter API access secret for device');
                        }
                        while (newApiAccessSecret !== null && newApiAccessSecret.length == 0);

                        if (newApiAccessSecret !== null) {
                            device.deviceId = ctrl.value;
                            device.apiAccessSecret = newApiAccessSecret;

                            clearResult();
                            initApiClient();
                        }
                        else {
                            resetDeviceIdField();
                        }
                    }
                }
                else {
                    resetDeviceIdField();
                }
            }

            function resetDeviceIdField() {
                document.getElementById('itxDeviceId').value = device.deviceId;
            }

            function fillWithLastTxid() {
                if (lastTxid) {
                    document.getElementById('itxTxid').value = lastTxid;
                }
            }

            function showArgs(label) {
                var argList = 'Source: ' + label;
                argList += '\nthis: ' + this;
                var args = Array.prototype.slice.call(arguments);
                args.shift();
                args.forEach(function (arg, idx) {
                    if (argList.length > 0) {
                        argList += '\n';
                    }
                    argList += 'Arg.#' + (idx + 1) + ': ' + JSON.stringify(arg);
                });
                alert(argList);
            }
        </script>
    </head>
    <body>
        <div id="divEnvironment">
            <label for="selEnvironment">Environment: </label><select id="selEnvironment" onchange="clearResult(); resetDevice(); initApiClient()">
                <option value="localhost" selected>localhost</option>
                <option value="Catenis-API">Catenis API server</option>
            </select>
            <br/><label for="itxDeviceId">Device ID: </label><input id="itxDeviceId" maxlength="20" size="30" onchange="updateDeviceId(this)"/>
            <script language="JavaScript">resetDeviceIdField()</script>
        </div>
        <div id="divMessage" style="margin-top:1em">
            <table>
                <tr>
                    <td valign="top" align="right">
                        <label for="itxMessage">Message: </label>
                    </td>
                    <td>
                        <textarea id="itxMessage" rows="5" cols="80"></textarea>
                        <br/><label for="selMsgEncoding">encoding: </label><select id="selMsgEncoding">
                            <option value="utf8" selected>UTF-8</option>
                            <option value="base64">Base-64</option>
                            <option value="hex">Hex</option>
                        </select>
                        <br/><label for="cbxMsgEncrypt">encrypt: </label><input id="cbxMsgEncrypt" type="checkbox" checked />
                        <br/><label for="selMsgStorage">storage: </label><select id="selMsgStorage">
                            <option value="auto" selected>Auto</option>
                            <option value="embedded">Embedded</option>
                            <option value="external">External</option>
                        </select>
                        <br/><button id="btnLogMessage" style="margin-top:10px" onclick="clearResult(); if(requireMessage()){logMessage(document.getElementById('itxMessage').value, document.getElementById('selMsgEncoding').value, document.getElementById('cbxMsgEncrypt').checked, document.getElementById('selMsgStorage').value)}else{return false}">Log Message</button>
                        <div style="margin-top:1em">
                            <table>
                                <tr>
                                    <td valign="top">
                                        <label for="itxTrgtDeviceId">Target device ID: </label>
                                    </td>
                                    <td>
                                        <input id="itxTrgtDeviceId" style="margin-bottom:0.5em" type="text" maxlength="40" size="40"/>
                                        <br/><label for="cbxProdUniqId">product unique ID: </label><input id="cbxProdUniqId" type="checkbox"/>
                                        <br/><button id="btnSendMessage" style="margin-top:10px" onclick="clearResult(); if(requireMessage() && requireTargetDevice()){sendMessage(document.getElementById('itxTrgtDeviceId').value, document.getElementById('cbxProdUniqId').checked, document.getElementById('itxMessage').value, document.getElementById('selMsgEncoding').value, document.getElementById('cbxMsgEncrypt').checked, document.getElementById('selMsgStorage').value)}else{return false}">Send Message</button>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td valign="top" align="right" style="padding-top:1.25em">
                        <label for="itxTxid">Transaction ID: </label>
                    </td>
                    <td style="padding-top:1em">
                        <input id="itxTxid" style="margin-bottom:0.5em" type="text" maxlength="64" size="80"/>
                        <div width="100%" align="right" style="margin-right:30px;margin-bottom:-1em"><a href="javascript:fillWithLastTxid()">Fill with last txid</a></div>
                        <label for="selRdMsgEncoding">encoding: </label><select id="selRdMsgEncoding">
                            <option value="utf8" selected>UTF-8</option>
                            <option value="base64">Base-64</option>
                            <option value="hex">Hex</option>
                        </select>
                        <br/><button id="btnReadMessage" style="margin-top:10px" onclick="clearResult(); if(requireTxid()){readMessage(document.getElementById('itxTxid').value, document.getElementById('selRdMsgEncoding').value)}else{return false}">Read Message</button>
                    </td>
                </tr>
            </table>
        </div>
        <div id="divResult" style="margin-top:1em">
            <label>Result:</label><br/>
            <p id="pReqResult"></p>
        </div>
        <script language="JavaScript">clearResult(); initApiClient()</script>
    </body>
</html>